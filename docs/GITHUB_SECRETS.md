# GitHub Secrets Setup for Firebase CI/CD

This guide explains how to set up GitHub Secrets so that CI/CD builds can access Firebase configuration files securely.

## Overview

Firebase configuration files (`google-services.json` and `firebase_options.dart`) are excluded from version control for security. GitHub Secrets allow CI/CD workflows to recreate these files during builds.

## Required Secrets

You need to add **2 secrets** to your GitHub repository:

1. `GOOGLE_SERVICES_JSON` - Android Firebase configuration
2. `FIREBASE_OPTIONS_DART` - Flutter Firebase configuration

---

## Step 1: Complete Firebase Setup Locally

Before setting up GitHub Secrets, you must complete the Firebase setup on your local machine:

1. Follow the instructions in [`FIREBASE_SETUP.md`](FIREBASE_SETUP.md)
2. Create a Firebase project
3. Download `google-services.json` to `android/app/`
4. Run `flutterfire configure` to generate `lib/firebase_options.dart`
5. Verify the app builds locally with Firebase

---

## Step 2: Prepare Secret Values

### Secret 1: GOOGLE_SERVICES_JSON

**Get the content:**

```bash
# From project root, copy the entire file content
cat android/app/google-services.json
```

**Copy the entire JSON output.** It should look like this:

```json
{
  "project_info": {
    "project_number": "123456789012",
    "project_id": "your-firebase-project",
    "storage_bucket": "your-firebase-project.appspot.com"
  },
  "client": [
    {
      "client_info": {
        "mobilesdk_app_id": "1:123456789012:android:abcdef1234567890",
        "android_client_info": {
          "package_name": "ralcock.cbf"
        }
      },
      "oauth_client": [],
      "api_key": [
        {
          "current_key": "AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
        }
      ],
      "services": {
        "appinvite_service": {
          "other_platform_oauth_client": []
        }
      }
    }
  ],
  "configuration_version": "1"
}
```

### Secret 2: FIREBASE_OPTIONS_DART

**Get the content:**

```bash
# From project root, copy the entire file content
cat lib/firebase_options.dart
```

**Copy the entire Dart file content.** It should look like this:

```dart
// File generated by FlutterFire CLI.
import 'package:firebase_core/firebase_core.dart' show FirebaseOptions;
import 'package:flutter/foundation.dart'
    show defaultTargetPlatform, kIsWeb, TargetPlatform;

class DefaultFirebaseOptions {
  static FirebaseOptions get currentPlatform {
    if (kIsWeb) {
      return web;
    }
    switch (defaultTargetPlatform) {
      case TargetPlatform.android:
        return android;
      // ... more platforms
    }
  }

  static const FirebaseOptions web = FirebaseOptions(
    apiKey: 'AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
    appId: '1:123456789012:web:abcdef1234567890',
    // ... more config
  );

  static const FirebaseOptions android = FirebaseOptions(
    apiKey: 'AIzaSyXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX',
    appId: '1:123456789012:android:abcdef1234567890',
    // ... more config
  );
}
```

---

## Step 3: Add Secrets to GitHub

### Option A: Via GitHub Web Interface

1. **Navigate to your repository on GitHub**
   - Go to: `https://github.com/YOUR_USERNAME/cambridge-beer-festival-app`

2. **Open Settings**
   - Click **Settings** tab (requires admin access)

3. **Navigate to Secrets**
   - In the left sidebar: **Secrets and variables** → **Actions**

4. **Add First Secret**
   - Click **New repository secret**
   - Name: `GOOGLE_SERVICES_JSON`
   - Value: Paste the entire content from `android/app/google-services.json`
   - Click **Add secret**

5. **Add Second Secret**
   - Click **New repository secret**
   - Name: `FIREBASE_OPTIONS_DART`
   - Value: Paste the entire content from `lib/firebase_options.dart`
   - Click **Add secret**

### Option B: Via GitHub CLI

```bash
# Install GitHub CLI if not already installed
# macOS: brew install gh
# Other: https://cli.github.com/

# Authenticate
gh auth login

# Add GOOGLE_SERVICES_JSON secret
gh secret set GOOGLE_SERVICES_JSON < android/app/google-services.json

# Add FIREBASE_OPTIONS_DART secret
gh secret set FIREBASE_OPTIONS_DART < lib/firebase_options.dart
```

---

## Step 4: Verify Secrets Are Set

### Check via Web Interface

1. Go to: Settings → Secrets and variables → Actions
2. You should see both secrets listed:
   - `GOOGLE_SERVICES_JSON`
   - `FIREBASE_OPTIONS_DART`

### Check via GitHub CLI

```bash
gh secret list
```

Expected output:
```
CLOUDFLARE_API_TOKEN       Updated 2024-XX-XX
CODECOV_TOKEN              Updated 2024-XX-XX
FIREBASE_OPTIONS_DART      Updated 2024-XX-XX
GOOGLE_SERVICES_JSON       Updated 2024-XX-XX
```

---

## Step 5: Test CI/CD Build

Push a change to trigger the workflow:

```bash
# Make a small change
echo "# Test" >> README.md

# Commit and push
git add README.md
git commit -m "Test Firebase CI/CD"
git push
```

**Monitor the workflow:**

1. Go to your repository on GitHub
2. Click **Actions** tab
3. Click on the running workflow
4. Check that these steps succeed:
   - "Create Firebase google-services.json"
   - "Create Firebase options"
   - "Get dependencies"
   - "Run tests"
   - "Build web" / "Build Android"

---

## How It Works

The GitHub Actions workflow (`.github/workflows/build-deploy.yml`) includes these steps:

```yaml
- name: Create Firebase google-services.json
  run: echo '${{ secrets.GOOGLE_SERVICES_JSON }}' > android/app/google-services.json

- name: Create Firebase options
  run: echo '${{ secrets.FIREBASE_OPTIONS_DART }}' > lib/firebase_options.dart
```

These steps:
1. Read the secret value from GitHub Secrets
2. Write it to the expected file location
3. Allow subsequent build steps to access the files

---

## Security Best Practices

### ✅ Do This

- **Keep secrets in GitHub Secrets** - Never commit them to the repository
- **Restrict repository access** - Only trusted collaborators should have admin access
- **Use environment-specific secrets** - Different secrets for staging/production
- **Rotate secrets periodically** - Update Firebase config if compromised
- **Enable branch protection** - Require reviews for changes to main branch

### ❌ Don't Do This

- **Don't commit secrets to Git** - They're in `.gitignore` for a reason
- **Don't share secret values** - Send setup instructions instead
- **Don't use secrets in fork PRs** - GitHub doesn't expose secrets to forks
- **Don't log secret values** - Be careful with debug output

---

## Troubleshooting

### Secret not found

**Error:** `secret GOOGLE_SERVICES_JSON not found`

**Solution:**
1. Verify secret name is exactly `GOOGLE_SERVICES_JSON` (case-sensitive)
2. Check you added it as a **repository secret**, not environment secret
3. Ensure you have admin access to the repository

### Invalid JSON format

**Error:** `Error parsing google-services.json`

**Solution:**
1. Verify the secret contains valid JSON
2. Check for trailing commas or syntax errors
3. Re-download from Firebase Console if needed
4. Use a JSON validator: https://jsonlint.com/

### Build fails with "Firebase not initialized"

**Solution:**
1. Verify both secrets are set correctly
2. Check workflow logs for file creation steps
3. Ensure `flutterfire configure` generated correct config
4. Verify secret contains complete file content

### Secrets not working in fork PRs

This is expected GitHub behavior. Secrets are not exposed to workflows triggered by forks for security reasons.

**Solution:**
- Contributors must set up their own Firebase project and secrets
- Or run tests locally before submitting PR
- Or maintainer merges to a branch in the main repo to trigger CI

---

## Updating Secrets

If you need to update Firebase configuration:

### Update GOOGLE_SERVICES_JSON

```bash
# After downloading new google-services.json from Firebase Console
gh secret set GOOGLE_SERVICES_JSON < android/app/google-services.json
```

Or via web interface:
1. Settings → Secrets and variables → Actions
2. Click **Update** next to `GOOGLE_SERVICES_JSON`
3. Paste new value
4. Click **Update secret**

### Update FIREBASE_OPTIONS_DART

```bash
# After running flutterfire configure
gh secret set FIREBASE_OPTIONS_DART < lib/firebase_options.dart
```

---

## Related Documentation

- [Firebase Setup Guide](FIREBASE_SETUP.md) - Complete Firebase setup instructions
- [GitHub Encrypted Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)
- [GitHub Actions Security](https://docs.github.com/en/actions/security-guides/security-hardening-for-github-actions)

---

## Quick Reference

```bash
# List all secrets
gh secret list

# Set/update a secret from file
gh secret set SECRET_NAME < path/to/file

# Set/update a secret from stdin
echo "secret value" | gh secret set SECRET_NAME

# Delete a secret
gh secret delete SECRET_NAME
```

---

## Need Help?

If you encounter issues:

1. Check the [Firebase Setup Guide](FIREBASE_SETUP.md)
2. Verify secrets are set correctly in GitHub Settings
3. Check GitHub Actions logs for specific error messages
4. Ensure local Firebase setup works before adding to CI/CD
5. Review this guide's troubleshooting section

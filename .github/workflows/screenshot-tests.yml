name: Screenshot Tests

on:
  pull_request:
    paths:
      - 'lib/**'
      - 'test/**'
      - 'pubspec.yaml'
      - '.github/workflows/screenshot-tests.yml'
  workflow_dispatch:
    inputs:
      update_goldens:
        description: 'Update golden files (true/false)'
        required: false
        default: 'false'

jobs:
  screenshot-tests:
    name: Run Screenshot Tests
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.3'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Run screenshot tests (validation mode)
        if: github.event_name == 'pull_request' && github.event.inputs.update_goldens != 'true'
        id: screenshot_tests
        run: flutter test test/screenshots/
        continue-on-error: true

      - name: Upload golden diffs on failure
        if: steps.screenshot_tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: golden-diffs
          path: |
            test/screenshots/failures/**/*.png
          if-no-files-found: warn
          retention-days: 7

      - name: Fail job if screenshot tests failed
        if: steps.screenshot_tests.outcome == 'failure'
        run: exit 1

      - name: Run screenshot tests (update goldens)
        if: github.event.inputs.update_goldens == 'true'
        run: flutter test test/screenshots/ --update-goldens

      - name: Copy screenshots to screenshots directory
        if: github.event.inputs.update_goldens == 'true'
        run: ./scripts/copy_screenshots.sh
          
      - name: Commit and push updated screenshots
        if: github.event.inputs.update_goldens == 'true'
        run: ./scripts/update_screenshot_branch.sh ${{ github.event.pull_request.number || 'manual' }} ${{ github.ref }}

      - name: Check for changed or new screenshots
        if: github.event_name == 'pull_request'
        id: check_changes
        run: ./scripts/check_screenshot_changes.sh ${{ github.base_ref }}

      - name: Comment on PR with screenshot changes
        if: github.event_name == 'pull_request' && success() && steps.check_changes.outputs.changed_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const changedCount = '${{ steps.check_changes.outputs.changed_count }}';
            const changedFiles = `${{ steps.check_changes.outputs.new_or_modified_files }}`.split('\n').filter(f => f);
            const prNumber = context.issue.number;
            
            const fileList = changedFiles.map(f => {
              const fileName = f.replace('test/screenshots/goldens/', '');
              const screenshotUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/blob/pr-screenshot/pr-${prNumber}/${fileName}`;
              return `- [\`${fileName}\`](${screenshotUrl})`;
            }).join('\n');
            
            const comment = `## üì∏ Screenshot Changes Detected
            
            This PR includes **${changedCount} new or modified screenshot(s)**:
            
            ${fileList}
            
            ### What this means:
            - ‚úÖ **Tests passed**: Screenshots match the updated golden files
            - üîç **Please review**: Verify these visual changes are intentional
            
            <details>
            <summary>How to review</summary>
            
            **Option 1: View in GitHub (after manual workflow run)**
            1. Screenshots will be in the [\`pr-screenshot\`](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/pr-screenshot/pr-${prNumber}) branch
            2. Click the links above to view each screenshot
            
            **Option 2: View locally**
            1. Check out this branch locally
            2. View the screenshots in \`test/screenshots/goldens/\`
            3. Compare with the base branch if needed
            
            </details>
            
            > **Note**: Screenshots are uploaded to \`pr-screenshot\` branch only when the "Update golden files" workflow is run manually.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Comment on PR - No screenshot changes
        if: github.event_name == 'pull_request' && success() && steps.check_changes.outputs.changed_count == '0'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚úÖ Screenshot Tests Passed
            
            All screenshot tests passed with no visual changes detected.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR with failure info
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå Visual Regression Detected
            
            Screenshot tests failed! This indicates visual changes that don't match the golden files.
            
            ### What happened:
            Some screenshots don't match the expected golden files. This could be:
            1. **Intentional UI changes** - You meant to change the UI
            2. **Unintentional regressions** - Something broke the UI accidentally
            
            ### Next steps:
            
            #### If changes are intentional:
            1. Review the visual changes carefully
            2. Go to **Actions ‚Üí Screenshot Tests** workflow
            3. Click **Run workflow** on your branch
            4. Set **Update golden files** to \`true\`
            5. Run the workflow to update the goldens
            
            #### If changes are unintentional:
            1. Check the uploaded failure artifacts (above) to see the differences
            2. Fix the UI regression in your code
            3. Push the fix to re-run tests
            
            ### View differences:
            Download the **golden-diffs** artifact from this workflow run to see what changed.
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

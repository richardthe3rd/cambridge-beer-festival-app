# Base mise configuration for all environments (including CI)
# For developer-specific tools (Claude, Firebase), use: MISE_ENV=dev mise install
#
# Task Configuration:
# - Each task can have a 'description' (short summary)
# - Tasks with arguments use 'usage' field with KDL syntax for arg/flag definitions
# - Arguments become available as $usage_<name> env vars (e.g., $usage_file)
# - For complex tasks, consider using file-tasks in .mise/tasks/ for better editing
#   Docs: https://mise.jdx.dev/tasks/task-arguments.html
#         https://mise.jdx.dev/tasks/file-tasks.html

[tools]
flutter = "3.38.3"
node = "21"  # For http_server and Playwright e2e tests

[tasks.install]
description = "Install Flutter dependencies (flutter pub get)"
run = 'flutter pub get'

[tasks.generate]
description = "Generate code (mocks, build_runner)"
run = 'dart run build_runner build --delete-conflicting-outputs'
# Sources: test files with @GenerateMocks annotations
sources = ['test/**/*_test.dart']
# Outputs: generated mock files
outputs = ['test/**/*.mocks.dart']

[tasks.test]
description = "Run all Flutter tests"
depends = ['generate']
run = 'flutter test'

[tasks.coverage]
description = "Run tests with coverage reporting (output: coverage/lcov.info)"
depends = ['generate']
run = '''
flutter test --coverage
echo "Coverage report generated at coverage/lcov.info"
echo "To view HTML report, install lcov and run: genhtml coverage/lcov.info -o coverage/html"
'''

[tasks.analyze]
description = "Run Flutter code analysis (no-fatal-infos mode)"
depends = ['generate']
run = 'flutter analyze --no-fatal-infos'

[tasks."test:worker"]
description = "Run Cloudflare Worker tests (Vitest + workerd)"
dir = "cloudflare-worker"
sources = ['cloudflare-worker/package.json', 'cloudflare-worker/package-lock.json', 'cloudflare-worker/worker.js', 'cloudflare-worker/test/**/*.js', 'cloudflare-worker/vitest.config.js', 'data/festivals.json']
run = 'npm ci && npm test'

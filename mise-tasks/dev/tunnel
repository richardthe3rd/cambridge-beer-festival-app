#!/usr/bin/env bash
# mise description="Start dev server with Cloudflare Tunnel (requires setup:tunnel first)"

set -euo pipefail

# Start Cloudflare Tunnel in the background
echo "Starting Cloudflare Tunnel..."
cloudflared tunnel --config .cloudflared/config.yml run &
TUNNEL_PID=$!

# Wait for tunnel to be ready
echo "Waiting for tunnel to start..."
sleep 3

echo ""
echo "âœ… Tunnel running at: https://tunnel.cambeerfestival.app"
echo ""
echo "Starting Flutter dev server on http://localhost:8080"
echo "Press Ctrl+C to stop both services."
echo ""

# Cleanup function
cleanup() {
  echo ""
  echo "Stopping tunnel..."
  kill $TUNNEL_PID 2>/dev/null
  exit
}

# Set up cleanup on exit
trap cleanup EXIT INT TERM

# Run Flutter in foreground without debug client (prevents WebSocket errors through tunnel)
flutter run -d web-server --web-port 8080 --no-injected-client

# Developer-specific mise configuration
# Load with: MISE_ENV=dev mise install
# Or set permanently: export MISE_ENV=dev in your shell rc file
#
# Note: Node.js is now in base mise.toml since it's needed for e2e tests in all environments
#
# Task Configuration:
# - Each task can have a 'description' (short summary)
# - Tasks with arguments use 'usage' field with KDL syntax for arg/flag definitions
# - Arguments become available as $usage_<name> env vars (e.g., $usage_url)
# - For complex tasks, consider using file-tasks in .mise/tasks/ for better editing
#   Docs: https://mise.jdx.dev/tasks/task-arguments.html
#         https://mise.jdx.dev/tasks/file-tasks.html

[tools]
claude = { version = "latest", bin = "claude", platforms = """
[linux-arm64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/linux-arm64/claude"

[linux-x64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/linux-x64/claude"

[macos-arm64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/darwin-arm64/claude"

[macos-x64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/darwin-x64/claude"
""", version_list_url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/stable" }
cloudflared = "latest"
gh = "latest"
"npm:firebase-tools" = "14.26.0"  # Pin to a stable version for reproducibility
"npm:playwright" = "1.48.2"  # Pin to match @playwright/test version for reproducibility

[tasks.dev]
description = "Start Flutter dev server on localhost:8080"
run = '''
echo "Starting Flutter dev server on http://localhost:8080"
flutter run -d web-server --web-port 8080 --pid-file flutter-dev.pid
'''

# Complex tasks moved to mise-tasks/ for better maintainability:
# - setup:tunnel -> mise-tasks/setup/tunnel
# - setup:playwright -> mise-tasks/setup/playwright
# - dev:tunnel -> mise-tasks/dev/tunnel
# - build:web:prod -> mise-tasks/build/web/prod

[tasks."test:e2e"]
description = "Run e2e tests with Playwright (headless mode)"
run = '''
echo "Running e2e tests with Playwright..."
npm run test:e2e
'''

[tasks."test:e2e:ui"]
description = "Run e2e tests in Playwright UI mode (interactive)"
run = '''
echo "Running e2e tests in UI mode..."
npm run test:e2e:ui
'''

[tasks."test:e2e:headed"]
description = "Run e2e tests in headed mode (visible browser)"
run = '''
echo "Running e2e tests in headed mode..."
npm run test:e2e:headed
'''

[tasks."build:web"]
description = "Build Flutter web app in release mode (for local testing/e2e)"
run = '''
echo "Building Flutter web app in release mode..."
flutter build web --release --base-href "/"
echo ""
echo "âœ… Build complete! Output at: build/web/"
echo ""
echo "To serve locally for testing:"
echo "  npx http-server build/web -p 8080"
'''

[tasks."serve:release"]
description = "Serve release build with http-server (SPA mode for deep linking)"
run = '''
if [ ! -d "build/web" ]; then
  echo "Error: build/web directory not found"
  echo "Run: mise run build:web first"
  exit 1
fi

echo "Starting http-server with SPA routing..."
echo "Available at: http://localhost:8080"
echo "Press Ctrl+C to stop"
npx http-server build/web -p 8080 --proxy http://localhost:8080?
'''

[tasks."test:check-page"]
description = "Check page for console errors and take screenshot"
usage = '''
arg "[url]" help="URL to check" default="http://localhost:8080"
arg "[screenshot]" help="Screenshot output path" default="screenshot.png"
'''
run = '''
URL="${usage_url:-http://localhost:8080}"
SCREENSHOT="${usage_screenshot:-screenshot.png}"

echo "Checking page: $URL"
echo "Screenshot will be saved to: $SCREENSHOT"
node scripts/check-page.mjs -u "$URL" -s "$SCREENSHOT"
'''

[tasks."screenshots:batch"]
description = "Capture screenshots of multiple pages from config file"
usage = '''
arg "[config]" help="Config file path" default="screenshots.config.json"
arg "[output]" help="Output directory" default="screenshots"
'''
run = '''
CONFIG="${usage_config:-screenshots.config.json}"
OUTPUT="${usage_output:-screenshots}"

echo "Running batch screenshot capture..."
echo "Config: $CONFIG"
echo "Output: $OUTPUT"
node scripts/screenshot-batch.mjs -c "$CONFIG" -o "$OUTPUT"
'''

# Developer-specific mise configuration
# Load with: MISE_ENV=dev mise install
# Or set permanently: export MISE_ENV=dev in your shell rc file
#
# Note: Node.js is now in base mise.toml since it's needed for e2e tests in all environments

[tools]
claude = { version = "latest", bin = "claude", platforms = """
[linux-arm64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/linux-arm64/claude"

[linux-x64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/linux-x64/claude"

[macos-arm64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/darwin-arm64/claude"

[macos-x64]
url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/{version}/darwin-x64/claude"
""", version_list_url = "https://storage.googleapis.com/claude-code-dist-86c565f3-f756-42ad-8dfa-d59b1c096819/claude-code-releases/stable" }
cloudflared = "latest"
gh = "latest"
"npm:firebase-tools" = "14.26.0"  # Pin to a stable version for reproducibility
"npm:playwright" = "latest"

[tasks.dev]
run = '''
echo "Starting Flutter dev server on http://localhost:8080"
flutter run -d web-server --web-port 8080
'''

[tasks.tunnel-setup]
run = '''
echo "Setting up Cloudflare Tunnel for tunnel.cambeerfestival.app"
echo ""

# Check if already logged in
if [ ! -f ~/.cloudflared/cert.pem ]; then
  echo "Step 1: Login to Cloudflare (browser will open)..."
  cloudflared tunnel login
else
  echo "✓ Already logged in to Cloudflare"
fi

# Check if tunnel already exists
if cloudflared tunnel list 2>/dev/null | grep -q "cbf-dev-tunnel"; then
  echo "✓ Tunnel 'cbf-dev-tunnel' already exists"
else
  echo ""
  echo "Step 2: Creating tunnel 'cbf-dev-tunnel'..."
  cloudflared tunnel create cbf-dev-tunnel
fi

# Route DNS
echo ""
echo "Step 3: Setting up DNS route for tunnel.cambeerfestival.app..."
cloudflared tunnel route dns cbf-dev-tunnel tunnel.cambeerfestival.app

echo ""
echo "✅ Setup complete! You can now run: MISE_ENV=dev ./bin/mise run dev-tunnel"
'''

[tasks.playwright-setup]
run = '''
echo "Setting up Playwright for e2e testing..."
echo ""

# Install npm dependencies if needed
if [ ! -d node_modules ]; then
  echo "Step 1: Installing npm dependencies..."
  npm install
else
  echo "✓ npm dependencies already installed"
fi

# Check if Playwright browsers are installed
if [ ! -d ~/.cache/ms-playwright/chromium-* ]; then
  echo ""
  echo "Step 2: Installing Playwright browsers..."
  npx playwright install chromium
else
  echo "✓ Playwright browsers already installed"
fi

# Install system dependencies (requires sudo)
echo ""
echo "Step 3: Installing Playwright system dependencies..."
echo "(This may prompt for sudo password)"
npx playwright install-deps chromium

echo ""
echo "✅ Playwright setup complete!"
echo ""
echo "You can now:"
echo "  - Run e2e tests: MISE_ENV=dev mise run test:e2e"
'''

[tasks."test:e2e"]
run = '''
echo "Running e2e tests with Playwright..."
npm run test:e2e
'''

[tasks."test:e2e:ui"]
run = '''
echo "Running e2e tests in UI mode..."
npm run test:e2e:ui
'''

[tasks."test:e2e:headed"]
run = '''
echo "Running e2e tests in headed mode..."
npm run test:e2e:headed
'''

[tasks.dev-tunnel]
run = '''
# Start Cloudflare Tunnel in the background
echo "Starting Cloudflare Tunnel..."
cloudflared tunnel --config .cloudflared/config.yml run &
TUNNEL_PID=$!

# Wait for tunnel to be ready
echo "Waiting for tunnel to start..."
sleep 3

echo ""
echo "✅ Tunnel running at: https://tunnel.cambeerfestival.app"
echo ""
echo "Starting Flutter dev server on http://localhost:8080"
echo "Press Ctrl+C to stop both services."
echo ""

# Cleanup function
cleanup() {
  echo ""
  echo "Stopping tunnel..."
  kill $TUNNEL_PID 2>/dev/null
  exit
}

# Set up cleanup on exit
trap cleanup EXIT INT TERM

# Run Flutter in foreground (so you can use 'r' for hot reload, etc.)
flutter run -d web-server --web-port 8080
'''
